<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Picker Wheel</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 650px;
            text-align: center;
        }

        h1 {
            color: #1a73e8; /* Google Blue */
            margin-bottom: 25px;
        }
        h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5f6368;
        }

        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #fff;
        }
        .input-group select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1765c7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:disabled {
            background-color: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }

        #wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wheel {
            width: 300px; 
            height: 300px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 5s cubic-bezier(0.33, 1, 0.68, 1); 
            background-color: #f8f9fa; 
        }

        #wheel canvas {
            display: block; 
        }

        #pointer { /* Pointer at 3 o'clock, pointing inwards (left) */
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 30px solid #d93025; /* Red pointer, base on right, tip on left */
            position: absolute;
            right: -5px; /* Position its base slightly outside wheel container for tip alignment */
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        #result {
            margin-top: 25px;
            font-size: 2.2em; 
            font-weight: bold;
            color: #1a73e8;
            padding: 15px;
            background-color: #e8f0fe; 
            border-radius: 8px;
            min-height: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .error-message {
            color: #d93025; 
            background-color: #fce8e6;
            border: 1px solid #d93025;
        }
        .info-message {
            color: #1765c7; 
            background-color: #e8f0fe;
            border: 1px solid #1a73e8;
        }
        .subtle-message {
            font-size: 0.9em;
            color: #5f6368;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Picker Wheel</h1>

        <p id="repoInfo" class="subtle-message">Attempting to load classes...</p>
        <p id="apiStatus" class="message" style="display:none;"></p>

        <div class="input-group" id="classSelectionGroup" style="display:none;">
            <label for="classSelect">Select a Class:</label>
            <select id="classSelect"></select>
        </div>

        <div id="wheel-section" style="display:none;">
            <h2>Spin the Wheel!</h2>
            <div id="wheel-container">
                <div id="pointer"></div>
                <div id="wheel">
                    <canvas id="wheelCanvas"></canvas>
                </div>
            </div>
            <button id="spinBtn" disabled>Spin</button>
            <div id="result">?</div>
        </div>
         <p id="studentsLeft" class="message info-message" style="display:none;"></p>
    </div>

    <script>
        const classSelect = document.getElementById('classSelect');
        const classSelectionGroup = document.getElementById('classSelectionGroup');
        const wheelSection = document.getElementById('wheel-section');
        const spinBtn = document.getElementById('spinBtn');
        const wheel = document.getElementById('wheel');
        const wheelCanvas = document.getElementById('wheelCanvas');
        const resultDisplay = document.getElementById('result');
        const apiStatus = document.getElementById('apiStatus');
        const studentsLeftDisplay = document.getElementById('studentsLeft');
        const repoInfoDisplay = document.getElementById('repoInfo');

        let GITHUB_USER = '';
        let GITHUB_REPO = '';
        const FOLDER_PATH = 'klassen'; 

        // const MANUAL_GITHUB_USER = "your-username"; // Uncomment for manual override
        // const MANUAL_GITHUB_REPO = "your-repo-name"; // Uncomment for manual override

        const GITHUB_API_BASE = 'https://api.github.com/repos';

        let allStudentsInClass = []; // Stores all names from the initially loaded class file
        let availableStudentsToPick = []; // Stores names not yet picked
        let classFilesData = []; 

        function setApiStatus(message, type = 'info') {
            apiStatus.textContent = message;
            apiStatus.className = `message ${type}-message`;
            apiStatus.style.display = 'block';
        }

        function setRepoInfo(message) {
            repoInfoDisplay.textContent = message;
            repoInfoDisplay.style.display = 'block';
        }

        async function autoDetectRepoAndFetchClasses() {
            if (typeof MANUAL_GITHUB_USER !== 'undefined' && MANUAL_GITHUB_USER &&
                typeof MANUAL_GITHUB_REPO !== 'undefined' && MANUAL_GITHUB_REPO) {
                GITHUB_USER = MANUAL_GITHUB_USER;
                GITHUB_REPO = MANUAL_GITHUB_REPO;
                setRepoInfo(`Using manual config: ${GITHUB_USER}/${GITHUB_REPO}.`);
            } else {
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;
                if (hostname.endsWith('github.io')) {
                    const parts = hostname.split('.');
                    GITHUB_USER = parts[0];
                    const pathSegments = pathname.split('/').filter(segment => segment.length > 0 && !segment.endsWith('.html'));
                    if (pathSegments.length > 0 && pathSegments[0].toLowerCase() !== FOLDER_PATH.toLowerCase()) {
                        GITHUB_REPO = pathSegments[0];
                    } else {
                        GITHUB_REPO = hostname;
                    }
                    setRepoInfo(`Detected: ${GITHUB_USER}/${GITHUB_REPO}.`);
                } else if (window.location.protocol === 'file:') {
                     setRepoInfo('Running locally. Automatic repo detection may not work.');
                     setApiStatus('For local use, ensure GITHUB_USER and GITHUB_REPO are set manually in the script if issues arise, or deploy to GitHub Pages.', 'info');
                     // Attempt to use manual if defined, otherwise this will likely fail if not on GH pages
                     if (typeof MANUAL_GITHUB_USER !== 'undefined' && MANUAL_GITHUB_USER) GITHUB_USER = MANUAL_GITHUB_USER;
                     if (typeof MANUAL_GITHUB_REPO !== 'undefined' && MANUAL_GITHUB_REPO) GITHUB_REPO = MANUAL_GITHUB_REPO;
                } else {
                    setRepoInfo('Could not auto-detect GitHub repository details.');
                    setApiStatus('Automatic repository detection failed. Please ensure this page is hosted on GitHub Pages or configure GITHUB_USER/REPO manually in the script.', 'error');
                    return; // Stop if no repo info
                }
            }
            
            if (GITHUB_USER && GITHUB_REPO) {
                await fetchClassesList();
            } else {
                 setApiStatus('GitHub user and repository not determined. Cannot fetch classes.', 'error');
            }
        }

        async function fetchClassesList() {
            setApiStatus(`Workspaceing classes from '${FOLDER_PATH}'...`, 'info');
            classSelectionGroup.style.display = 'none';
            wheelSection.style.display = 'none';

            try {
                const response = await fetch(`${GITHUB_API_BASE}/${GITHUB_USER}/${GITHUB_REPO}/contents/${FOLDER_PATH}`);
                if (!response.ok) {
                    let errorMsg = `Error fetching classes list: ${response.statusText} (Status: ${response.status}).`;
                    if (response.status === 404) errorMsg = `Folder '${FOLDER_PATH}' not found in ${GITHUB_USER}/${GITHUB_REPO}, or repository is private/incorrect.`;
                    else if (response.status === 403) errorMsg = 'API rate limit exceeded or access forbidden. Check repo permissions/API limits.';
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                
                classFilesData = data
                    .filter(file => file.type === 'file' && file.name.endsWith('.txt'))
                    .map(file => ({ name: file.name.replace('.txt', ''), download_url: file.download_url }));

                if (classFilesData.length === 0) {
                    setApiStatus(`No .txt files found in '${FOLDER_PATH}' of ${GITHUB_USER}/${GITHUB_REPO}.`, 'error');
                    return;
                }

                populateClassSelector();
                classSelectionGroup.style.display = 'block';
                setApiStatus('Classes list loaded. Please select a class.', 'info');
                repoInfoDisplay.style.display = 'none';

            } catch (error) {
                console.error('Error fetching classes list:', error);
                setApiStatus(`${error.message}`, 'error');
            }
        }

        function populateClassSelector() {
            classSelect.innerHTML = '<option value="">-- Select a Class --</option>';
            classFilesData.forEach(file => {
                const option = document.createElement('option');
                option.value = file.download_url;
                option.textContent = file.name;
                classSelect.appendChild(option);
            });
            wheelSection.style.display = 'none';
        }

        classSelect.addEventListener('change', async (event) => {
            const fileUrl = event.target.value;
            resultDisplay.textContent = '?'; 
            studentsLeftDisplay.style.display = 'none';
            wheel.style.transform = 'rotate(0deg)'; 
            currentWheelRotation = 0; // Reset wheel rotation state

            if (!fileUrl) {
                wheelSection.style.display = 'none';
                allStudentsInClass = [];
                availableStudentsToPick = [];
                spinBtn.disabled = true;
                drawWheel([]);
                return;
            }

            setApiStatus('Loading student list...', 'info');
            spinBtn.disabled = true;

            try {
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`Workspaceing student list failed: ${response.statusText}`);
                
                const textContent = await response.text();
                allStudentsInClass = textContent.split('\n').map(name => name.trim()).filter(name => name.length > 0);
                availableStudentsToPick = [...allStudentsInClass];

                if (allStudentsInClass.length === 0) {
                    setApiStatus('No students found in this class file, or file is empty/misformatted.', 'error');
                    wheelSection.style.display = 'block';
                    spinBtn.disabled = true;
                    drawWheel([]);
                } else {
                    drawWheel(allStudentsInClass); // Draw wheel with ALL students
                    wheelSection.style.display = 'block';
                    spinBtn.disabled = false;
                    updateStudentsLeftDisplay();
                    setApiStatus('Student list loaded. Ready to spin!', 'info');
                }

            } catch (error) {
                console.error('Error loading student list:', error);
                setApiStatus(`Error loading students: ${error.message}`, 'error');
                wheelSection.style.display = 'block'; 
                spinBtn.disabled = true;
                drawWheel([]); 
            }
        });

        let isSpinning = false;
        let currentWheelRotation = 0; 

        function drawWheel(namesToDraw) { // Renamed parameter for clarity
            const ctx = wheelCanvas.getContext('2d');
            const numSegments = namesToDraw.length;
            const canvasSize = 300;
            wheelCanvas.width = canvasSize;
            wheelCanvas.height = canvasSize;

            const centerX = canvasSize / 2;
            const centerY = canvasSize / 2;
            const radius = canvasSize / 2 - 5; 

            ctx.clearRect(0, 0, canvasSize, canvasSize);

            if (numSegments === 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = '#f0f0f0';
                ctx.fill();
                ctx.strokeStyle = '#ccc';
                ctx.stroke();
                ctx.fillStyle = '#555';
                ctx.font = 'bold 18px "Segoe UI", Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No Students', centerX, centerY);
                return;
            }

            const anglePerSegment = (2 * Math.PI) / numSegments;
            const colors = ["#4285F4", "#DB4437", "#F4B400", "#0F9D58", "#AB47BC", "#00ACC1", "#FF7043", "#7E57C2", "#5C6BC0", "#26A69A"];
            ctx.font = 'bold 13px "Segoe UI", Arial'; 

            namesToDraw.forEach((name, i) => {
                const startAngle = i * anglePerSegment;
                const endAngle = (i + 1) * anglePerSegment;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = '#fff'; 
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerSegment / 2);
                ctx.textAlign = 'right'; 
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#ffffff'; 
                
                const displayName = name.length > 15 ? name.substring(0, 13) + '...' : name;
                ctx.fillText(displayName, radius - 10, 0); 
                ctx.restore();
            });
        }

        spinBtn.addEventListener('click', () => {
            if (isSpinning || availableStudentsToPick.length === 0) return;

            isSpinning = true;
            spinBtn.disabled = true;
            resultDisplay.textContent = 'Spinning...';

            // Select a winner from the *available* students
            const winnerName = availableStudentsToPick[Math.floor(Math.random() * availableStudentsToPick.length)];
            
            // Find the winner's index in the *original full list* for visual targeting
            const visualIndexOfWinner = allStudentsInClass.indexOf(winnerName);
            const numTotalSegmentsOnWheel = allStudentsInClass.length;

            const anglePerSegmentDegrees = 360 / numTotalSegmentsOnWheel;
            const targetSegmentMiddleAngleDegrees = (visualIndexOfWinner + 0.5) * anglePerSegmentDegrees;
            
            const randomExtraRotations = 3 + Math.floor(Math.random() * 3); 
            const targetRotation = (randomExtraRotations * 360) - targetSegmentMiddleAngleDegrees + (Math.random() * anglePerSegmentDegrees * 0.4 - anglePerSegmentDegrees * 0.2);

            currentWheelRotation += targetRotation; 
            wheel.style.transform = `rotate(${currentWheelRotation}deg)`;

            setTimeout(() => {
                isSpinning = false;
                resultDisplay.textContent = `${winnerName}`;
                
                const winnerIdxInAvailable = availableStudentsToPick.indexOf(winnerName);
                if (winnerIdxInAvailable > -1) {
                    availableStudentsToPick.splice(winnerIdxInAvailable, 1);
                }
                updateStudentsLeftDisplay();

                if (availableStudentsToPick.length > 0) {
                    // DO NOT redraw the wheel. It keeps showing all original names.
                    spinBtn.disabled = false;
                } else {
                    // All students picked. Now clear the wheel.
                    drawWheel([]); 
                    studentsLeftDisplay.textContent = 'All students have been picked!';
                    studentsLeftDisplay.style.display = 'block';
                    spinBtn.disabled = true;
                }
            }, 5000); 
        });
        
        function updateStudentsLeftDisplay() {
            if (availableStudentsToPick.length > 0) {
                studentsLeftDisplay.textContent = `${availableStudentsToPick.length} student(s) remaining to be picked.`;
                studentsLeftDisplay.style.display = 'block';
            } else if (allStudentsInClass.length > 0 && availableStudentsToPick.length === 0) {
                 studentsLeftDisplay.textContent = 'All students have been picked!';
                 studentsLeftDisplay.style.display = 'block';
            }
            else {
                studentsLeftDisplay.style.display = 'none';
            }
        }

        window.onload = () => {
            drawWheel([]); 
            autoDetectRepoAndFetchClasses();
        };
    </script>
</body>
</html>
