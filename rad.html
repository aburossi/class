<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Picker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 650px;
            text-align: center;
        }

        h1 {
            color: #1a73e8; /* Google Blue */
            margin-bottom: 25px;
        }
        h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5f6368;
        }

        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #fff;
        }
        .input-group select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1765c7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:disabled {
            background-color: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }

        #wheel-container { /* Renamed semantically, but reusing ID for less JS change */
            position: relative;
            width: 320px; /* Width of the display area */
            height: 80px; /* Height of the display area */
            margin: 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 5px; /* Padding around the inner canvas container */
            box-sizing: border-box;
        }

        #wheel { /* This is the container for the canvas */
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: #f8f9fa; /* Background for the canvas area */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }

        #wheel canvas {
            display: block;
            /* width and height set in JS */
        }

        #pointer {
            display: none; /* Pointer not needed for this animation */
        }

        #result {
            margin-top: 25px;
            font-size: 2.2em;
            font-weight: bold;
            color: #1a73e8;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 8px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .error-message {
            color: #d93025;
            background-color: #fce8e6;
            border: 1px solid #d93025;
        }
        .info-message {
            color: #1765c7;
            background-color: #e8f0fe;
            border: 1px solid #1a73e8;
        }
        .subtle-message {
            font-size: 0.9em;
            color: #5f6368;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Picker</h1>

        <p id="repoInfo" class="subtle-message">Attempting to load classes...</p>
        <p id="apiStatus" class="message" style="display:none;"></p>

        <div class="input-group" id="classSelectionGroup" style="display:none;">
            <label for="classSelect">Select a Class:</label>
            <select id="classSelect"></select>
        </div>

        <div id="wheel-section" style="display:none;">
            <h2>Picking a Student...</h2> <div id="wheel-container">
                <div id="pointer"></div> <div id="wheel"> <canvas id="wheelCanvas"></canvas>
                </div>
            </div>
            <button id="spinBtn" disabled>Pick Student</button> <div id="result">?</div>
        </div>
        <p id="studentsLeft" class="message info-message" style="display:none;"></p>
    </div>

    <script>
        const classSelect = document.getElementById('classSelect');
        const classSelectionGroup = document.getElementById('classSelectionGroup');
        const wheelSection = document.getElementById('wheel-section');
        const spinBtn = document.getElementById('spinBtn');
        const wheelCanvas = document.getElementById('wheelCanvas');
        const resultDisplay = document.getElementById('result');
        const apiStatus = document.getElementById('apiStatus');
        const studentsLeftDisplay = document.getElementById('studentsLeft');
        const repoInfoDisplay = document.getElementById('repoInfo');

        let GITHUB_USER = '';
        let GITHUB_REPO = '';
        const FOLDER_PATH = 'klassen';

        // const MANUAL_GITHUB_USER = "your-username";
        // const MANUAL_GITHUB_REPO = "your-repo-name";

        const GITHUB_API_BASE = 'https://api.github.com/repos';

        let allStudentsInClass = [];
        let availableStudentsToPick = [];
        let classFilesData = [];

        let isSpinning = false;

        // --- New Animation Specific Variables ---
        const NORMAL_FONT = 'bold 24px "Segoe UI", Arial';
        const WINNER_FONT = 'bold 38px "Segoe UI", Arial'; // Slightly larger winner font
        const TEXT_COLOR = '#333333';
        let currentDisplayedClassName = "Select a Class"; // To store the name of the selected class
        // --- End New Animation Specific Variables ---


        function setApiStatus(message, type = 'info') {
            apiStatus.textContent = message;
            apiStatus.className = `message ${type}-message`;
            apiStatus.style.display = 'block';
        }

        function setRepoInfo(message) {
            repoInfoDisplay.textContent = message;
            repoInfoDisplay.style.display = 'block';
        }

        async function autoDetectRepoAndFetchClasses() {
            // ... (This function remains the same as your previous version) ...
            if (typeof MANUAL_GITHUB_USER !== 'undefined' && MANUAL_GITHUB_USER &&
                typeof MANUAL_GITHUB_REPO !== 'undefined' && MANUAL_GITHUB_REPO) {
                GITHUB_USER = MANUAL_GITHUB_USER;
                GITHUB_REPO = MANUAL_GITHUB_REPO;
                setRepoInfo(`Using manual config: ${GITHUB_USER}/${GITHUB_REPO}.`);
            } else {
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;
                if (hostname.endsWith('github.io')) {
                    const parts = hostname.split('.');
                    GITHUB_USER = parts[0];
                    const pathSegments = pathname.split('/').filter(segment => segment.length > 0 && !segment.endsWith('.html'));
                     if (pathSegments.length > 0 && pathSegments[0].toLowerCase() !== FOLDER_PATH.toLowerCase()) {
                        GITHUB_REPO = pathSegments[0];
                    } else {
                        GITHUB_REPO = pathSegments[0] || GITHUB_USER + ".github.io";
                    }
                    setRepoInfo(`Detected: ${GITHUB_USER}/${GITHUB_REPO}.`);
                } else if (window.location.protocol === 'file:') {
                    setRepoInfo('Running locally. Automatic repo detection may not work.');
                    setApiStatus('For local use, ensure GITHUB_USER and GITHUB_REPO are set manually in the script if issues arise, or deploy to GitHub Pages.', 'info');
                    if (typeof MANUAL_GITHUB_USER !== 'undefined' && MANUAL_GITHUB_USER) GITHUB_USER = MANUAL_GITHUB_USER;
                    if (typeof MANUAL_GITHUB_REPO !== 'undefined' && MANUAL_GITHUB_REPO) GITHUB_REPO = MANUAL_GITHUB_REPO;
                } else {
                    setRepoInfo('Could not auto-detect GitHub repository details.');
                    setApiStatus('Automatic repository detection failed. Please ensure this page is hosted on GitHub Pages or configure GITHUB_USER/REPO manually in the script.', 'error');
                    return;
                }
            }

            if (GITHUB_USER && GITHUB_REPO) {
                await fetchClassesList();
            } else {
                setApiStatus('GitHub user and repository not determined. Cannot fetch classes.', 'error');
            }
        }

        async function fetchClassesList() {
            // ... (This function remains the same as your previous version) ...
            setApiStatus(`Workspaceing classes from '${FOLDER_PATH}'...`, 'info');
            classSelectionGroup.style.display = 'none';
            wheelSection.style.display = 'none';

            try {
                const response = await fetch(`${GITHUB_API_BASE}/${GITHUB_USER}/${GITHUB_REPO}/contents/${FOLDER_PATH}`);
                if (!response.ok) {
                    let errorMsg = `Error fetching classes list: ${response.statusText} (Status: ${response.status}).`;
                    if (response.status === 404) errorMsg = `Folder '${FOLDER_PATH}' not found in ${GITHUB_USER}/${GITHUB_REPO}, or repository is private/incorrect. Check path and permissions.`;
                    else if (response.status === 403) errorMsg = 'API rate limit exceeded or access forbidden. Check repo permissions/API limits.';
                    throw new Error(errorMsg);
                }
                const data = await response.json();

                classFilesData = data
                    .filter(file => file.type === 'file' && file.name.endsWith('.txt'))
                    .map(file => ({ name: file.name.replace('.txt', ''), download_url: file.download_url }));

                if (classFilesData.length === 0) {
                    setApiStatus(`No .txt files found in '${FOLDER_PATH}' of ${GITHUB_USER}/${GITHUB_REPO}.`, 'error');
                    return;
                }

                populateClassSelector();
                classSelectionGroup.style.display = 'block';
                setApiStatus('Classes list loaded. Please select a class.', 'info');
                repoInfoDisplay.style.display = 'none';

            } catch (error) {
                console.error('Error fetching classes list:', error);
                setApiStatus(`${error.message}`, 'error');
            }
        }

        function populateClassSelector() {
            // ... (This function remains the same) ...
            classSelect.innerHTML = '<option value="">-- Select a Class --</option>';
            classFilesData.forEach(file => {
                const option = document.createElement('option');
                option.value = file.download_url;
                option.textContent = file.name;
                classSelect.appendChild(option);
            });
            wheelSection.style.display = 'none';
        }


        function drawNameOnCanvas(name, isWinner = false) {
            const ctx = wheelCanvas.getContext('2d');
            const canvasWidth = wheelCanvas.width;
            const canvasHeight = wheelCanvas.height;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = isWinner ? WINNER_FONT : NORMAL_FONT;

            if (!name) {
                name = "?"; // Default placeholder
            }
            // Adjust truncation based on typical name length and font size
            const maxLength = isWinner ? 15 : 18;
            const displayName = name.length > maxLength ? name.substring(0, maxLength - 2) + '...' : name;

            ctx.fillText(displayName, canvasWidth / 2, canvasHeight / 2);
        }

        classSelect.addEventListener('change', async (event) => {
            const fileUrl = event.target.value;
            currentDisplayedClassName = event.target.options[event.target.selectedIndex].text;

            resultDisplay.textContent = '?';
            studentsLeftDisplay.style.display = 'none';

            if (!fileUrl) {
                wheelSection.style.display = 'none';
                allStudentsInClass = [];
                availableStudentsToPick = [];
                spinBtn.disabled = true;
                currentDisplayedClassName = "Select a Class";
                drawNameOnCanvas(currentDisplayedClassName);
                return;
            }

            setApiStatus('Loading student list...', 'info');
            spinBtn.disabled = true;
            wheelSection.style.display = 'block';
            drawNameOnCanvas(currentDisplayedClassName); // Show class name while loading

            try {
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`Workspaceing student list failed: ${response.statusText}`);

                const textContent = await response.text();
                allStudentsInClass = textContent.split('\n').map(name => name.trim()).filter(name => name.length > 0);
                availableStudentsToPick = [...allStudentsInClass];

                if (allStudentsInClass.length === 0) {
                    setApiStatus('No students found in this class file, or file is empty/misformatted.', 'error');
                    drawNameOnCanvas("No Students in Class");
                    spinBtn.disabled = true;
                } else {
                    setApiStatus('Student list loaded. Ready to pick!', 'info');
                    drawNameOnCanvas(currentDisplayedClassName); // Show class name as default idle display
                    spinBtn.disabled = false;
                }
                updateStudentsLeftDisplay();

            } catch (error) {
                console.error('Error loading student list:', error);
                setApiStatus(`Error loading students: ${error.message}`, 'error');
                drawNameOnCanvas("Error Loading List");
                spinBtn.disabled = true;
            }
        });

        spinBtn.addEventListener('click', () => {
            if (isSpinning || availableStudentsToPick.length === 0) return;

            isSpinning = true;
            spinBtn.disabled = true;
            resultDisplay.textContent = 'Picking...';

            const winnerName = availableStudentsToPick[Math.floor(Math.random() * availableStudentsToPick.length)];

            const animationTotalDuration = 3000; // 3 seconds total for cycling names
            const nameChangeInterval = 100;   // Change name every 100ms
            let elapsedTime = 0;
            let animationIntervalId;

            function cycleNamesEffect() {
                elapsedTime += nameChangeInterval;
                if (elapsedTime < animationTotalDuration) {
                    // Display a random student name from the full class list for visual effect
                    const randomIndex = Math.floor(Math.random() * allStudentsInClass.length);
                    const tempNameToShow = allStudentsInClass[randomIndex];
                    drawNameOnCanvas(tempNameToShow, false);
                } else {
                    clearInterval(animationIntervalId);
                    finalizePick();
                }
            }

            function finalizePick() {
                drawNameOnCanvas(winnerName, true); // Display winner, larger

                isSpinning = false;
                resultDisplay.textContent = `${winnerName}`;

                const winnerIdxInAvailable = availableStudentsToPick.indexOf(winnerName);
                if (winnerIdxInAvailable > -1) {
                    availableStudentsToPick.splice(winnerIdxInAvailable, 1);
                }
                updateStudentsLeftDisplay();

                if (availableStudentsToPick.length > 0) {
                    spinBtn.disabled = false;
                } else {
                    studentsLeftDisplay.textContent = 'All students have been picked!';
                    studentsLeftDisplay.style.display = 'block';
                    spinBtn.disabled = true;
                    setTimeout(() => { // After showing winner, update canvas
                        if (allStudentsInClass.length > 0) {
                             drawNameOnCanvas(`All ${allStudentsInClass.length} picked!`, false);
                        } else {
                             drawNameOnCanvas("All picked!", false);
                        }
                    }, 2500); // Wait a bit before showing "All picked" on canvas
                }
            }

            if (allStudentsInClass.length > 0) { // Ensure there are names to cycle through
                animationIntervalId = setInterval(cycleNamesEffect, nameChangeInterval);
            } else { // Should ideally not happen if button is enabled
                finalizePick(); // Directly show winner (or placeholder if list was empty)
            }
        });

        function updateStudentsLeftDisplay() {
            // ... (This function remains the same) ...
            if (availableStudentsToPick.length > 0 && allStudentsInClass.length > 0) {
                studentsLeftDisplay.textContent = `${availableStudentsToPick.length} student(s) remaining to be picked.`;
                studentsLeftDisplay.style.display = 'block';
            } else if (allStudentsInClass.length > 0 && availableStudentsToPick.length === 0) {
                studentsLeftDisplay.textContent = 'All students have been picked!';
                studentsLeftDisplay.style.display = 'block';
            } else {
                studentsLeftDisplay.style.display = 'none';
            }
        }

        window.onload = () => {
            // Set fixed canvas dimensions based on CSS for #wheel
            const wheelElement = document.getElementById('wheel');
            wheelCanvas.width = wheelElement.clientWidth > 0 ? wheelElement.clientWidth : 300;
            wheelCanvas.height = wheelElement.clientHeight > 0 ? wheelElement.clientHeight : 50;

            currentDisplayedClassName = "Select a Class";
            drawNameOnCanvas(currentDisplayedClassName);
            autoDetectRepoAndFetchClasses();
        };
    </script>
</body>
</html>
